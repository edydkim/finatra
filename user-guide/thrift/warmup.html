<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Thrift Server Warmup &#8212; Finatra User&#39;s Guide 2.12.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/flasky.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.12.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="top" title="Finatra User&#39;s Guide 2.12.0 documentation" href="../index.html" />
    <link rel="next" title="TwitterServer Admin HTTP Server" href="../twitter-server/index.html" />
    <link rel="prev" title="Thrift Exception Mapping" href="exceptions.html" />
   
  
  <link media="only screen and (max-device-width: 480px)" href="../_static/small_flask.css" type= "text/css" rel="stylesheet" />
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-39101739-4', 'twitter.github.io');
    ga('send', 'pageview');

  </script>

  </head>
  <body role="document">
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../twitter-server/index.html" title="TwitterServer Admin HTTP Server"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="exceptions.html" title="Thrift Exception Mapping"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Finatra</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="thrift-server-warmup">
<span id="thrift-warmup"></span><h1>Thrift Server Warmup<a class="headerlink" href="#thrift-server-warmup" title="Permalink to this headline">¶</a></h1>
<p>There may be occasions where we want to exercise specific code paths before accepting traffic to the server (e.g., for triggering JIT in the JVM).
In this case you can implement a <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-utils/src/main/scala/com/twitter/inject/utils/Handler.scala">c.t.inject.utils.Handler</a> and your handler should be constructed with a <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/thrift/src/main/scala/com/twitter/finatra/thrift/routing/ThriftWarmup.scala">c.t.finatra.thrift.routing.ThriftWarmup</a> instance.</p>
<p>For example, if we wanted to run an initial call through our Thrift service we could create the following handler:</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>import ExampleThriftController
import com.twitter.example.thriftscala.ExampleService.Add1
import com.twitter.inject.Logging
import com.twitter.inject.utils.Handler
import com.twitter.util.{Await, Return, Throw, Try}
import javax.inject.Inject

class ExampleThriftWarmupHandler @Inject()(
 warmup: ThriftWarmup)
 extends Handler
 with Logging {

  /* Should be a ClientId that is white-listed to your service. */
  private val clientId = ClientId(&quot;client123&quot;)

  override def handle() = {
    try {
        clientId.asCurrent {
          warmup.send(
            method = Add1,
            args = Add1.Args(5)) { result: Try[Add1.SuccessType] =&gt;
              result match {
                case Return(value) =&gt; assert(value == 6, &quot;Warmup request failed.&quot;)
                case Throw(_) =&gt; assert(false, &quot;Warmup request failed.&quot;)
              }
            }
        }
    } catch {
      case e: Throwable =&gt;
        // Here we don&#39;t want a warmup failure to prevent server start-up --
        // this is important if your service will call downstream services
        // during warmup that could be temporarily down or unavailable.
        // We don&#39;t want that unavailability to cause our server to fail
        // warm-up and prevent the server from starting. So we simply log
        // the error message here.
        error(e.getMessage, e)
    } finally {
      warmup.close()
    }
    info(&quot;Warm-up done.&quot;)
  }
}
</pre></div>
</div>
<p>You can then run this handler in the <cite>warmup</cite> lifecycle method:</p>
<div class="code scala highlight-text"><div class="highlight"><pre><span></span>import DoEverythingModule
import com.twitter.finatra.thrift.ThriftServer
import com.twitter.finatra.thrift.routing.ThriftRouter
import com.twitter.finatra.thrift.filters._

object ExampleServerMain extends ExampleServer

class ExampleServer extends ThriftServer {

  override val modules = Seq(
    DoEverythingModule)

  override def configureThrift(router: ThriftRouter): Unit = {
    router
      .filter[LoggingMDCFilter]
      .filter[TraceIdMDCFilter]
      .filter[ThriftMDCFilter]
      .filter[AccessLoggingFilter]
      .filter[StatsFilter]
      .add[ExampleThriftController]
  }

  override def warmup() {
    handle[ExampleThriftWarmupHandler]()
  }
}
</pre></div>
</div>
<p>The <a class="reference external" href="https://github.com/twitter/finatra/blob/develop/inject/inject-app/src/main/scala/com/twitter/inject/app/App.scala#L122">c.t.inject.app.App#warmup</a> lifecycle method is called before the server&#8217;s external Thrift port is bound and thus before the TwitterServer <a class="reference external" href="https://twitter.github.io/twitter-server/Features.html#lifecycle-management">Lifecycle Management</a> <cite>/health</cite> endpoint responds with <cite>OK</cite>.</p>
<p>See <a class="reference external" href="../getting-started/lifecycle.html">here</a> for more information on the lifecycle of a Finatra server.</p>
<div class="section" id="more-information">
<h2>More information<a class="headerlink" href="#more-information" title="Permalink to this headline">¶</a></h2>
<p>For more information, we encourage you to take a look at the full <a class="reference external" href="https://github.com/twitter/finatra/tree/master/examples">finatra/examples</a> in the <a class="reference external" href="https://github.com/twitter/finatra">github</a> source.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/finatra_logo.png" alt="Logo"/>
            </a></p><p>
  Finatra is a Scala services framework built on top of <a href="https://twitter.github.io/twitter-server/">TwitterServer</a> and <a href="https://twitter.github.io/finagle/">Finagle</a>.
</p>

<h3>Useful Links</h3>
<ul>
  <li><a href="https://twitter.github.io/finatra/">Site&nbsp;&amp;&nbsp;Blog</a></li>
  <li><a href="https://github.com/twitter/finatra">Github&nbsp;Repository</a></li>
  <li><a href="https://github.com/twitter/finatra/issues">Issues</a></li>
</ul>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Thrift Server Warmup</a><ul>
<li><a class="reference internal" href="#more-information">More information</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="exceptions.html" title="previous chapter">Thrift Exception Mapping</a></li>
      <li>Next: <a href="../twitter-server/index.html" title="next chapter">TwitterServer Admin HTTP Server</a></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Search the contents of this site.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  
    <div class="github-fork-ribbon-wrapper right fixed" style="width: 150px;height: 150px;position: fixed;overflow: hidden;top: 0;z-index: 9999;pointer-events: none;right: 0;"><div class="github-fork-ribbon" style="position: absolute;padding: 2px 0;background-color: #900;background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));-webkit-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);-moz-box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);z-index: 9999;pointer-events: auto;top: 42px;right: -43px;-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);-ms-transform: rotate(45deg);-o-transform: rotate(45deg);transform: rotate(45deg);"><a target="_blank" href="https://github.com/twitter/finatra" style="font: 700 13px &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif;color: #fff;text-decoration: none;text-shadow: 0 -1px rgba(0, 0, 0, 0.5);text-align: center;width: 200px;line-height: 20px;display: inline-block;padding: 2px 0;border-width: 1px 0;border-style: dotted;border-color: rgba(255, 255, 255, 0.7);">Fork me on GitHub</a></div></div>
  

  <div class="footer">
    &copy; Copyright 2013-2017 Twitter, Inc.
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</div>
  
  </body>
</html>